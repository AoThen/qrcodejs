<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>QR Code JS Demo</title>
	<style type="text/css">
	html, body {
		font-family: sans-serif;
	}
	#text {
		width: 90%;
	}
	#output {
		cursor: copy;
		font-family: monospace;
		-webkit-font-smoothing: none;
		font-smooth: never;
		text-rendering: optimizeSpeed;
		line-height: 1.1;
		white-space: nowrap;
	}
	/* Fix for monospace fonts where the space is not the same width as the block characters */
	#output span {
		display: inline-block;
		width: 1ch;
	}
	</style>
</head>
<body>
<h1>QR Code JS Demo</h1>

<ul>
  <li>Generate a text-based QR Code for your input.</li>
  <li>Click/tap the code to copy to your clipboard.</li>
  <li>Open source repository: <a href="https://github.com/danielgjackson/qrcodejs">github.com/danielgjackson/qrcodejs</a></li>
</ul>

<div><label>Text: <input type="text" id="text"></label></div>

<div id="output">
-
</div>

</body>
<script type="module">
import QrCode from './qrcode.mjs';

function outputMedium(matrix, padding = 4) {
    const lines = [];
    for (let y = -padding; y < matrix.dimension + padding; y += 2) {
        const parts = [];
        for (let x = -padding; x < matrix.dimension + padding; x++) {
            const upper = matrix.getModule(x, y);
            const lower = y + 1 < matrix.dimension ? matrix.getModule(x, y + 1) : 0;
            let c = '?';
            // '▀', '▄', '█' // '\u{0020}' space, '\u{2580}' upper half block, '\u{2584}' lower half block, '\u{2588}' block
            // Figure space: '\u{2007}'
            if (upper && lower) c = '<span>█</span>';
            else if (upper && !lower) c = '<span>▀</span>';
            else if (!upper && lower) c = '<span>▄</span>';
            else if (!upper && !lower) c = '<span>&nbsp;</span>'; // ' ';
            parts.push(c);
        }
        const line = parts.join('');
        lines.push(line);
    }    
    return lines.join('<br>');
}

function focus() {
	document.querySelector('#text').select();
}

function change() {
	let output;
	try {
		const text = document.querySelector('#text').value;
		const options = {
			errorCorrectionLevel: QrCode.ErrorCorrectionLevel.L,
		};
		const matrix = QrCode.generate(text, options);
		output = outputMedium(matrix);
	} catch (e) {
		output = 'Error: ' + e;
	}
	document.querySelector('#output').innerHTML = output;
}

function click() {
	const text = document.querySelector('#output').innerText;
	const temp = document.createElement('textarea');
	temp.value = text;
	document.body.appendChild(temp);
	temp.select();
	document.execCommand('copy');
	document.body.removeChild(temp);
	document.querySelector('#text').focus();
}

function start() {
	document.querySelector('#text').addEventListener('focus', focus);
	document.querySelector('#text').addEventListener('input', change);
	document.querySelector('#output').addEventListener('click', click);
	document.querySelector('#text').focus();
	change();
}

window.addEventListener('DOMContentLoaded', start);

</script>
</html>
